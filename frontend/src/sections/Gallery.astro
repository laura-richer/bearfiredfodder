---
import getUrlForImage from '@/utils/getUrlForImage';
import Button from '@/components/Button.astro';

const { title, images, id } = Astro.props;
---

<section id={id} class="gallery">
  <div class="container gallery__container">
    <h2>{title}</h2>

    <div class="gallery__image-wrapper">
      <div id="gallery-images" class="gallery__images">
        {images.map(image => <img src={getUrlForImage(image).url()} alt={image.alt} />)}
      </div>
    </div>

    <div class="gallery__skip-button">
      <Button text="Skip to contact details" link="#contact" />
    </div>
  </div>
</section>

<script>
import debounce from 'lodash/debounce';
import Macy from 'macy';

const skipButton = document.querySelector('.gallery__skip-button');
const galleryImages = document.querySelector('#gallery-images');
const breakpoint = getComputedStyle(document.documentElement).getPropertyValue(
  '--breakpoint-desktop'
);

const setMobileBreakpoint = () => {
  return !window.matchMedia(`(min-width: ${breakpoint})`).matches;
};

let mobileBreakpoint = setMobileBreakpoint();

const handleResize = debounce(() => {
  mobileBreakpoint = setMobileBreakpoint();
}, 100);

window.addEventListener('load', handleResize);
window.addEventListener('resize', handleResize);

const macy = Macy({
  container: '#gallery-images',
  margin: 20,
  columns: 4,
  breakAt: {
    1440: 3,
    1024: 2,
    680: 1,
  },
});

const renderGalleryNavigation = () => {
  const galleryImagesNavigationCount = Math.ceil(galleryImages.clientHeight / 500);

  if (galleryImagesNavigationCount <= 1 || mobileBreakpoint) {
    skipButton.style.display = 'flex';
    return;
  }

  skipButton.remove();
  const galleryNavigationItemActiveClass = 'gallery__navigation-item--active';

  // Build gallery navigation wrapper
  const galleryImagesNavigation = document.createElement('div');
  galleryImagesNavigation.classList.add('gallery__navigation');

  // Build gallery navigation items
  for (let index = 0; index < galleryImagesNavigationCount; index++) {
    const galleryImagesNavigationItem = document.createElement('span');
    galleryImagesNavigationItem.classList.add('gallery__navigation-item');

    if (index === 0) galleryImagesNavigationItem.classList.add(galleryNavigationItemActiveClass);
    galleryImagesNavigationItem.dataset.slide = index;

    galleryImagesNavigationItem.addEventListener('click', event => {
      galleryImagesNavigation.childNodes.forEach(galleryItemNavigation => {
        galleryItemNavigation.classList.remove(galleryNavigationItemActiveClass);
      });

      event.target.classList.add(galleryNavigationItemActiveClass);
      const { slide } = event.target.dataset;
      galleryImages.style.transform = `translateY(-${slide * 500}px)`;
    });

    galleryImagesNavigation.append(galleryImagesNavigationItem);
  }

  document.querySelector('.gallery__image-wrapper').append(galleryImagesNavigation);
};

macy.runOnImageLoad(renderGalleryNavigation);

// TODO destroy event listners
</script>

<style lang="scss" is:global>
  .gallery {
    position: relative;
    background: var(--color-grey) url('/images/bff-flame-cutoff-gallery.png') no-repeat left bottom;
    background-size: auto 270px;

    &:after {
      position: absolute;
      content: '';
      width: 100%;
      height: 100px;
      background: transparent;
      background: linear-gradient(
        0deg,
        rgba(2, 0, 36, 1) 0%,
        rgba(48, 48, 48, 1) 0%,
        rgba(255, 255, 255, 0) 100%
      );
      bottom: 0;
      left: 0;
    }

    &__container {
      padding-bottom: 0;
    }

    &__image-wrapper {
      position: relative;
      max-height: 500px;
      overflow: auto;

      @media screen and (min-width: 768px) {
        max-height: 750px;
      }

      @media screen and (min-width: 1024px) {
        overflow: hidden;
      }
    }

    &__images {
      transition: transform 0.7s ease-in-out;

      @media screen and (min-width: 1024px) {
        width: calc(100% - 3rem);
      }
    }

    &__navigation {
      position: absolute;
      right: 0;
      top: 50%;
      display: flex;
      flex-direction: column;
      z-index: 10;
      gap: 0.5rem;

      &-item {
        cursor: pointer;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background-color: var(--color-black);
        transition: background-color 0.3s ease-in-out;

        &--active,
        &:hover,
        &:focus {
          background-color: var(--color-red);
        }
      }
    }

    &__skip-button {
      position: absolute;
      display: none;
      justify-content: center;
      left: 0;
      right: 0;
      bottom: var(--spacer-s);
      z-index: 9999;
      left: 0;
      right: 0;
      margin: auto;
    }
  }
</style>
